<!DOCTYPE html><html><head><title>Ticket: <%= thread.username %></title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><script src="/socket.io/socket.io.js"></script><style>body{background-color:#2b2d31;color:#ddd;height:100vh;display:flex;flex-direction:column;}.chat-container{flex:1;overflow-y:auto;padding-bottom:80px;}.msg-row{display:flex;margin-bottom:15px;align-items:flex-end;}.msg-staff{flex-direction:row-reverse;}.msg-user{flex-direction:row;}.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;margin:0 10px;border:2px solid #444;}.bubble{max-width:70%;padding:10px 15px;position:relative;word-wrap:break-word;}.msg-staff .bubble{background-color:#FFA500;color:black;border-radius:15px 15px 0 15px;}.msg-user .bubble{background-color:#383a40;color:white;border-radius:15px 15px 15px 0;}.meta{font-size:0.75rem;color:#aaa;margin-bottom:2px;}.msg-staff .meta{text-align:right;margin-right:55px;}.msg-user .meta{text-align:left;margin-left:55px;}.img-preview{max-width:100%;border-radius:8px;margin-top:5px;cursor:pointer;}.input-area{background-color:#232428;border-top:1px solid #1e1f22;padding:20px;}</style></head><body><nav class="navbar navbar-dark bg-dark p-3 shadow-sm"><div class="container-fluid"><span class="navbar-brand"><img src="<%= thread.avatar %>" width="30" class="rounded-circle me-2">Chat with <strong><%= thread.username %></strong></span><div><form action="/mail/<%= thread._id %>/archive" method="POST" style="display:inline;"><button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Archive?')">ðŸ“¦ Archive</button></form><a href="/dashboard" class="btn btn-outline-light btn-sm ms-2">Back</a></div></div></nav><div class="container mt-4 chat-container" id="chatBox"><% thread.messages.forEach(function(m){ %><div class="meta <%= m.author==='Staff'?'msg-staff':'msg-user' %>"><%= m.authorName %> â€¢ <%= m.timestamp.toLocaleTimeString() %></div><div class="msg-row <%= m.author==='Staff'?'msg-staff':'msg-user' %>"><img src="<%= m.avatar %>" class="avatar"><div class="bubble"><%= m.content %><% if(m.attachment){ %><br><a href="<%= m.attachment %>" target="_blank"><img src="<%= m.attachment %>" class="img-preview"></a><% } %></div></div><% }); %></div><div class="input-area fixed-bottom"><div class="container"><form id="replyForm" enctype="multipart/form-data"><div class="input-group"><input type="file" name="image" class="form-control bg-dark text-light" style="max-width:50px;"><input type="text" name="content" id="msgInput" class="form-control bg-dark text-light" placeholder="Reply..." autocomplete="off"><button type="submit" class="btn btn-warning fw-bold">Send</button></div></form></div></div><script>const socket=io();const threadId='<%= thread._id %>';const chatBox=document.getElementById('chatBox');socket.emit('join_thread',threadId);chatBox.scrollTop=chatBox.scrollHeight;socket.on('new_message',(msg)=>{const isStaff=msg.author==='Staff';const metaDiv=document.createElement('div');metaDiv.className=`meta ${isStaff?'msg-staff':'msg-user'}`;metaDiv.innerHTML=`${msg.authorName} â€¢ ${new Date(msg.timestamp).toLocaleTimeString()}`;const rowDiv=document.createElement('div');rowDiv.className=`msg-row ${isStaff?'msg-staff':'msg-user'}`;let attachHtml='';if(msg.attachment){attachHtml=`<br><a href="${msg.attachment}" target="_blank"><img src="${msg.attachment}" class="img-preview"></a>`;}rowDiv.innerHTML=`<img src="${msg.avatar}" class="avatar"><div class="bubble">${msg.content}${attachHtml}</div>`;chatBox.appendChild(metaDiv);chatBox.appendChild(rowDiv);chatBox.scrollTop=chatBox.scrollHeight;});document.getElementById('replyForm').addEventListener('submit',async(e)=>{e.preventDefault();const formData=new FormData(e.target);document.getElementById('msgInput').value='';await fetch(`/mail/${threadId}/reply`,{method:'POST',body:formData,headers:{'Accept':'application/json'}});});</script></body></html>
